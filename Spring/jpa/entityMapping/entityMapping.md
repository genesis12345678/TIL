# 엔티티 매핑
> `JPA`를 사용하는 데 가장 중요한 두 가지는 영속성 컨텍스트의 내부 동작 원리를 이해하는 것과 엔티티와 테이블을 정확히 매핑하는 것이다.
> 
> `JPA`는 다양한 매핑 어노테이션을 지원한다.

대표적인 어노테이션
- **객체와 테이블 매핑** : `@Entitiy`, `@Table`
- **기본 키 매핑** : `@Id`
- **필드와 컬럼 매핑** : `Column`
- **연관관계 매핑** `@ManyToOne`, `@JoinColumn`

## @Entity
> `JPA`를 사용해서 테이블과 매핑할 클래스는 `@Entity`어노테이션을 필수로 붙여야 한다.
> 
> `@Entity`가 붙은 클래스는 `JPA`가 관리하고 엔티티라 부른다.

- `@Entity 속성`

| 속성   | 기능                                            | 기본 값              |
|------|-----------------------------------------------|-------------------|
| name | JPA에서 사용할 엔티티 이름을 지정한다. 보통 기본값인 클래스 이름을 사용한다. | 클래스 이름을 그대로 사용한다. |

- `@Entity` 적용 시 주의 사항
  - 기본 생성자는 필수다(파라미터가 없는 `public` 또는 `protected`)
  - final 클래스, enum, interface, inner 클래스에는 사용할 수 없다.
  - 저장할 필드에 `final`을 사용하면 안 된다.

자바에서는 생성자가 하나도 없으면 기본 생성자를 자동으로 만들어 주는데 생성자를 하나 이상 만들면 기본 생성자를 직접 만들어야 한다.

## @Table
> 엔티티와 매핑할 테이블을 지정한다.

- `@Table 속성`

| 속성                     | 기능                                                           | 기본 값             |
|------------------------|--------------------------------------------------------------|------------------|
| name                   | 매핑할 테이블 이름                                                   | 엔티티 이름을 사용한다. |
| catalog                | catalog 기능이 있는 DB에서 catalog를 매핑한다.                           ||
| schema                 | schema 기능이 있는 DB에서 schema 매핑한다.                              ||
| uniqueConstraints(DDL) | DDL 생성 시에 유니크 제약조건을 만든다. 스키마 자동 생성 기능을 사용해서 DDL을 만들 때만 사용된다. ||


## 데이터베이스 스키마 자동 생성
> `JPA`는 데이터베이스 스키마를 자동으로 생성하는 기능을 지원한다. JPA는 매핑 정보로 데이터베이스 방언을 사용해서 데이터베이스 스키마를 생성한다.

- properties
```properties
hibernate.hbm2ddl.auto=create
```
스키마 자동 생성 기능을 사용하면 애플리케이션 실행 시점에 DB 테이블이 자동으로 생성되므로 개발자가 테이블을 직접 생성하지 않아도 된다.

- hibernate.hbm2ddl.auto 속성

| 옵션          | 설명                                                                            |
|-------------|-------------------------------------------------------------------------------|
| create      | 기존 테이블을 삭제하고 새로 생성한다.                                                         |
| create-drop | create 속성에 추가로 애플리케이션을 종료할 때 생성한 DDL을 제거한다.                                   |
| update      | DB 테이블과 엔티티 매핑정보를 비교해서 변경 사항만 수정한다.                                           |
| validate    | DB 테이블과 엔티티 매핑정보를 비교해서 차이가 있으면 경고를 남기고 애플리케이션을 실행하지 않는다. 이 설정은 DDL을 수정하지 않는다. |
| none        | 자동 생성 기능을 사용하지 않는다.                                                           |


## 필드와 컬럼 매핑

### @Column
> 객체 필드를 테이블 컬럼과 매핑한다. 속성 중에 `name`, `nullable`이 주로 사용된다.

- `@Column 속성`

| 속성                        | 기능                                                                                                                                                  | 기본 값                               |
|---------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------|
| **name**                  | 필드와 매핑할 테이블의 컬럼 이름                                                                                                                                  | 객체의 필드 이름                          |
| **insertable**            | 엔티티 저장 시 이 필드도 같이 저장한다. `false`는 읽기 전용일 때 사용                                                                                                        | `true`                             |
| **updatable**             | 엔티티 저장 시 이 필드도 같이 수정한다. `false`는 읽기 전용일 때 사용                                                                                                        | `true`                             |
| **nullable**(DDL)         | null 값의 허용 여부 설정. `false`로 하면 DDL 생성 시 not null 제약조건이 붙는다.                                                                                          | `true`                             |
| **unique**(DDL)           | 한 컬럼에 유니크 제약조건 설정                                                                                                                                   |                                    |
| **columnDefinition**(DDL) | DB 컬럼 정보를 직접 줄 수 있다.                                                                                                                                | 필드의 자바 타입과 방언 정보를 사용해 적절한 컬럼 타입 생성 |
| **length**                | 문자 길이 제약조건으로 `String` 타입에만 사용한다.                                                                                                                    | 255                                |
| **percision, scale**(DDL) | `BidDecimal`,`BigInteger`타입에서 사용한다. `percision`은 소수점을 포함한 전체 자릿수, `scale`은 소수의 자릿수. `double`,`float`타입에는 적용되지 않는다. 아주 큰 숫자가 정밀한 소수를 다루어야 할 때만 사용한다. | precision=19, scale=2              |

**`@Column`을 생략하면 `int`, `double`같은 자바 기본 타입일 때는 null을 입력할 수 없으므로 JPA에서 자동으로 `not null`제약 조건을 추가해준다. `Integer`같은 객체 타입일 때만
null을 허용한다. 기본 타입에 `@Column`을 사용하면 `nullable=ture`가 기본값이므로 기본 타입에 `@Column`을 사용할 때는 `nullable=false`를 지정하는 것이 안전하다.**

### @Enumerated
> 자바의 `enum` 타입 매핑

- `@Enumerated 속성`

|속성| 기능                                                                           |기본 값|
|--|------------------------------------------------------------------------------|--|
|value| - EnumType.ORDINAL : enum 순서를 DB에 저장<br/>- EnumType.STRING : enum 이름을 DB에 저장 |EnumType.ORDINAL|

**`EnumType.ORDINAL` 사용을 지양하자.**

### @Lob
> 데이터베이스 `BLOB`, `CLOB` 타입과 매핑한다.

`@Lob`에는 지정할 수 있는 속성이 없고 매핑하는 필드 타입이 문자면 `CLOB`, 나머지는 `BLOB`으로 매핑한다.

### @Transient
> 이 필드는 매핑하지 않는다. DB에 저장하지 않고 조회하지도 않는다. 객체에 임시로 어떤 값을 보관하고 싶을 때 사용한다.

<br>

## 기본 키 매핑

- 직접 할당 : `@Id`만 사용
  - `em.persist()`를 호출하기 전에 애플리케이션에서 직접 식별자 값을 할당해야 한다. 식별자 값이 없으면 예외가 발생한다.
- 자동 생성 : `@GeneratedValue`
  - **IDENTITY** : 기본 키 생성을 데이터베이스에 위임
    - DB에 엔티티를 저장해서 식별자 값을 획득한 후 영속성 컨텍스트에 저장한다.
    - **테이블에 데이터를 저장해야 식별자 값을 획득할 수 있다.(쓰기 지연이 동작하지 않음)**
  - **SEQUENCE** : 데이터베이스 시퀀스를 사용해서 기본 키할당
    - DB 시퀀스에서 식별자 값을 획득한 후 영속성 컨텍스트에 저장한다.
  - **TABLE** : 키 생성 테이블 사용
    - DB 시퀀스 생성용 테이블에서 식별자 값을 획득한 후 영속성 컨텍스트에 저장한다.
  - **AUTO** : 방언에 따라 자동 지정, 기본값이다.