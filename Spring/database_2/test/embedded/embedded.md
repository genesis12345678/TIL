# 테스트 임베디드 모드 DB
> 테스트를 위해서 별도의 DB를 운영하는 것은 비효율적인 작업일 수도 있다.

## 임베디드 모드
H2 DB는 자바로 개발되어 있고 JVM 안에서 메모리 모드로 동작하는 기능을 제공한다. 

```java
@Bean
@Profile("test")
public DataSource dataSource() {
	log.info("메모리 데이터베이스 초기화");
	DriverManagerDataSource dataSource = new DriverManagerDataSource();
	dataSource.setDriverClassName("org.h2.Driver");
	dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");
	dataSource.setUsername("sa");
	dataSource.setPassword("");
	return dataSource;
}
```
- `@Profile("test")` : 테스트 케이스에서만 이 데이터소스를 스프링 빈으로 등록해서 사용한다.
- `dataSource`
  - `jdbc:h2:mem:db` : 임베디드 모드(메모리 모드)로 동작하는 H2 DB를 사용할 수 있다.
  - `DB_CLOSE_DELAY=-1` : 임베디드 모드에서는 DB 커넥션 연결이 끊어지면 DB도 종료되는데 그것을 방지한다.

메모리 DB는 애플리케이션이 종료될 때 함께 사라지기 때문에 애플리케이션 실행 시점에 DB 테이블도 새로 만들어주어야 한다. 스프링 부트는 SQL 스크립트를 실행해서
애플리케이션 로딩 시점에 DB를 초기화하는 기능을 제공한다.

- `src/test/resources/schema.sql`
```sql
drop table if exists item CASCADE; 
create table item
(
    id        bigint generated by default as identity, 
    item_name varchar(10),
    price integer, 
    quantity integer,
primary key (id) 
);
```
- SQL 스크립트가 잘 실행되는지 로그 확인
```properties
logging.level.org.springframework.jdbc=debug
```

<br>

## 스프링 부트 임베디드 모드

스프링 부트는 DB에 대한 별다른 설정이 없으면 기본으로 임베디드 DB를 사용한다. 
```java
@Bean
@Profile("test")
public DataSource dataSource(){
        log.info("메모리 데이터베이스 초기화");
        DriverManagerDataSource dataSource=new DriverManagerDataSource();
        dataSource.setDriverClassName("org.h2.Driver");
        dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");
        dataSource.setUsername("sa");
        dataSource.setPassword("");
        return dataSource;
}
```
위와 같은 설정과 `test/application.properties`에 데이터 소스 설정을 안해 주면 스프링 부트는 임베디드 모드로 접근하는 데이터 소스를 만들어서 제공한다.